<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Report Analyser</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap');

  :root {
    --ink: #1a1814;
    --paper: #f5f0e8;
    --cream: #ede7d6;
    --accent: #c84b2f;
    --muted: #8a8278;
    --border: rgba(26,24,20,0.15);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    padding: 2rem;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 999;
    opacity: 0.5;
  }

  .masthead {
    border-bottom: 2px solid var(--ink);
    padding-bottom: 1rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: baseline;
    gap: 1.5rem;
    flex-wrap: wrap;
  }

  .masthead h1 {
    font-family: 'DM Serif Display', serif;
    font-size: clamp(2rem, 5vw, 3.5rem);
    line-height: 1;
    letter-spacing: -0.02em;
  }

  .masthead h1 em { font-style: italic; color: var(--accent); }

  .masthead .tagline {
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    border-left: 1px solid var(--border);
    padding-left: 1.5rem;
  }

  .settings {
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1.25rem 1.5rem;
    margin-bottom: 1.5rem;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.75rem 1.5rem;
    align-items: center;
  }

  .settings label {
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    white-space: nowrap;
  }

  .settings input[type="text"],
  .settings select {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 0.4rem 0.6rem;
    color: var(--ink);
    width: 100%;
    max-width: 400px;
  }

  .settings input[type="text"]:focus,
  .settings select:focus {
    outline: none;
    border-color: var(--accent);
  }

  .upload-zone {
    border: 2px dashed var(--border);
    background: var(--cream);
    border-radius: 4px;
    padding: 3rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    position: relative;
    margin-bottom: 1.5rem;
  }

  .upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--accent);
    background: #f0e8d8;
  }

  .upload-zone input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .upload-icon { font-size: 2.5rem; margin-bottom: 0.75rem; display: block; }

  .upload-zone h2 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.4rem;
    margin-bottom: 0.4rem;
  }

  .upload-zone p { font-size: 0.75rem; color: var(--muted); letter-spacing: 0.05em; }

  #status {
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    color: var(--muted);
    margin-bottom: 1.5rem;
    min-height: 1.2em;
    text-transform: uppercase;
  }
  #status.error { color: var(--accent); }
  #status.success { color: #2a7a3b; }

  .progress-bar { height: 2px; background: var(--cream); border-radius: 2px; overflow: hidden; margin-bottom: 2rem; display: none; }
  .progress-bar.visible { display: block; }
  .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

  .results { display: none; }
  .results.visible { display: block; }

  .section-header {
    display: flex;
    align-items: baseline;
    gap: 1rem;
    margin: 2.5rem 0 1rem;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0.5rem;
  }

  .section-header h2 { font-family: 'DM Serif Display', serif; font-size: 1.6rem; }
  .section-header .count { font-size: 0.7rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); }

  .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 2rem; }

  table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }

  thead tr { background: var(--ink); color: var(--paper); }

  thead th {
    padding: 0.6rem 0.9rem;
    text-align: left;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-size: 0.65rem;
    white-space: nowrap;
  }

  thead th.center { text-align: center; }

  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: var(--cream); }
  tbody tr.gold { background: #fdf6e0; }
  tbody tr.gold:hover { background: #f9efcd; }

  td { padding: 0.55rem 0.9rem; vertical-align: middle; }
  td.name { font-family: 'DM Serif Display', serif; font-size: 0.95rem; white-space: nowrap; }
  td.center { text-align: center; font-variant-numeric: tabular-nums; }

  .pill {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 2px;
    font-size: 0.72rem;
    background: var(--cream);
    border: 1px solid var(--border);
    white-space: nowrap;
  }
  .pill.top    { background: #d8f0dd; border-color: #9ecba6; color: #1a5c24; }
  .pill.bottom { background: #fde8e3; border-color: #e8b0a2; color: #7a2010; }
  .pill.missing { color: var(--muted); background: transparent; border-color: transparent; font-style: italic; }

  .position-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.8rem;
    height: 1.8rem;
    border-radius: 50%;
    font-size: 0.7rem;
    font-weight: 500;
    background: var(--cream);
    border: 1px solid var(--border);
  }
  .position-badge.p1 { background: #f0d060; border-color: #c9a030; color: #5a3a00; }
  .position-badge.p2 { background: #d8d8d8; border-color: #aaa; color: #333; }
  .position-badge.p3 { background: #e8c498; border-color: #c09060; color: #5a3010; }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1.2rem;
    border: 1px solid var(--ink);
    background: var(--ink);
    color: var(--paper);
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 2px;
    transition: background 0.15s, color 0.15s;
  }
  .btn:hover { background: var(--accent); border-color: var(--accent); }
  .btn.secondary { background: transparent; color: var(--ink); }
  .btn.secondary:hover { background: var(--ink); color: var(--paper); }

  .actions { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem; }

  details { margin-top: 2rem; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
  summary { padding: 0.6rem 1rem; cursor: pointer; font-size: 0.7rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); background: var(--cream); user-select: none; }
  details pre { padding: 1rem; font-size: 0.7rem; line-height: 1.6; white-space: pre-wrap; word-break: break-word; max-height: 300px; overflow-y: auto; background: #fff; }

  footer { margin-top: 3rem; padding-top: 1rem; border-top: 1px solid var(--border); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); text-align: center; }
</style>
</head>
<body>

<div class="masthead">
  <h1>Report<br><em>Analyser</em></h1>
  <p class="tagline">Upload ¬∑ Parse ¬∑ Rank<br>All processing in your browser</p>
</div>

<div class="settings">
  <label for="yearSelect">Year Group</label>
  <select id="yearSelect">
    <option value="7">Year 7</option>
    <option value="8">Year 8</option>
    <option value="9">Year 9</option>
    <option value="10">Year 10</option>
    <option value="11">Year 11</option>
    <option value="12" selected>Year 12</option>
  </select>

  <label for="rankKey">Rank search key</label>
  <input type="text" id="rankKey" value="Overall Assessment Rank" placeholder="e.g. Overall Assessment Rank" />
</div>

<div class="upload-zone" id="uploadZone">
  <input type="file" id="fileInput" accept=".pdf" />
  <span class="upload-icon">üìÑ</span>
  <h2>Drop your PDF here</h2>
  <p>or click to browse ‚Äî no data leaves your device</p>
</div>

<div id="status"></div>
<div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>

<div class="results" id="results">
  <div class="actions">
    <button class="btn" onclick="exportCSV('ranks')">‚¨á Export ranks CSV</button>
    <button class="btn" onclick="exportCSV('best')">‚¨á Export leaderboard CSV</button>
    <button class="btn secondary" onclick="resetTool()">‚Ü∫ Load another PDF</button>
  </div>

  <div class="section-header">
    <h2>Subject Ranks by Student</h2>
    <span class="count" id="rankCount"></span>
  </div>
  <div class="table-wrap"><table id="rankTable"></table></div>

  <div class="section-header">
    <h2>Overall Leaderboard</h2>
    <span class="count" id="boardCount"></span>
  </div>
  <div class="table-wrap"><table id="leaderTable"></table></div>

  <details>
    <summary>üîç Debug ‚Äî raw extracted text</summary>
    <pre id="rawText"></pre>
  </details>
</div>

<footer>Report Analyser &mdash; Client-side only &mdash; PDF.js &mdash; No data transmitted</footer>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let parsedData = null;

const zone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');

zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
zone.addEventListener('drop', e => {
  e.preventDefault();
  zone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file && file.type === 'application/pdf') handleFile(file);
  else setStatus('Please drop a PDF file.', 'error');
});
fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

function setStatus(msg, type = '') {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.className = type;
}

function setProgress(pct) {
  const bar = document.getElementById('progressBar');
  const fill = document.getElementById('progressFill');
  if (pct === null) { bar.classList.remove('visible'); return; }
  bar.classList.add('visible');
  fill.style.width = pct + '%';
}

async function handleFile(file) {
  setStatus('Loading PDF‚Ä¶');
  setProgress(5);

  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  const totalPages = pdf.numPages;

  let fullText = '';
  for (let i = 1; i <= totalPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();

    const items = content.items.slice().sort((a, b) => {
      const dy = b.transform[5] - a.transform[5];
      return Math.abs(dy) > 3 ? dy : a.transform[4] - b.transform[4];
    });

    const lines = [];
    let lastY = null;
    let line = [];
    for (const item of items) {
      const y = Math.round(item.transform[5]);
      if (lastY !== null && Math.abs(y - lastY) > 3) {
        if (line.length) lines.push(line.join(' '));
        line = [];
      }
      if (item.str.trim()) line.push(item.str.trim());
      lastY = y;
    }
    if (line.length) lines.push(line.join(' '));

    fullText += lines.join('\n') + '\n--- PAGE BREAK ---\n';
    setProgress(5 + Math.round((i / totalPages) * 60));
  }

  document.getElementById('rawText').textContent = fullText;
  setProgress(70);
  setStatus('Parsing student data‚Ä¶');

  const year = document.getElementById('yearSelect').value;
  const rankKey = document.getElementById('rankKey').value.trim() || 'Overall Assessment Rank';
  parsedData = parseText(fullText, year, rankKey);
  setProgress(90);

  if (!parsedData.students.length) {
    setStatus('No student data found. Check the debug panel below to see extracted text.', 'error');
    document.getElementById('results').classList.add('visible');
    setProgress(null);
    return;
  }

  renderTables(parsedData);
  setProgress(null);
  setStatus(`‚úì Found ${parsedData.students.length} students across ${parsedData.allSubjects.length} subjects.`, 'success');
  document.getElementById('results').classList.add('visible');
  document.getElementById('uploadZone').style.display = 'none';
}

function parseText(text, year, rankKey) {
  const lines = text.split('\n').map(l => l.trim()).filter(Boolean);

  // "SMITH, John Semester 2, 2025 - 12-1 - 12"
  const studentRe = /^([A-Z][A-Z'\-]+(?:\s+[A-Z][A-Z'\-]+)*,\s+[A-Z][a-zA-Z'\-]+(?:\s+[A-Z][a-zA-Z'\-]*)*)\s+Semester\b/;

  // Subject: everything before a class code that starts with the selected year number
  // e.g. Year 12 ‚Üí matches "12MXX1", Year 7 ‚Üí matches "7ENG1"
  const escapedYear = year.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const subjectRe = new RegExp(`^(.+?)(?:\\s+-\\s+(?:HSC|Preliminary)?)?\\s+${escapedYear}[A-Z]{2,}[\\dA-Z]*`);

  // Rank line using user-supplied key
  const escapedKey = rankKey.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const rankRe = new RegExp(`${escapedKey}[:\\s]+(\\d+)\\s*\\/\\s*(\\d+)`, 'i');

  const students = [];
  let curStudent = null;
  let pendingSubject = null;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (line.includes('--- PAGE BREAK ---')) continue;

    // New student
    const studentMatch = line.match(studentRe);
    if (studentMatch) {
      curStudent = { name: studentMatch[1].trim(), subjects: [] };
      students.push(curStudent);
      pendingSubject = null;
      continue;
    }

    if (!curStudent) continue;

    // Rank line
    const rankMatch = line.match(rankRe);
    if (rankMatch) {
      const rank = parseInt(rankMatch[1]);
      const total = parseInt(rankMatch[2]);
      if (pendingSubject) {
        curStudent.subjects.push({ name: pendingSubject, rank, total });
        pendingSubject = null;
      }
      continue;
    }

    // Subject line
    const subMatch = line.match(subjectRe);
    if (subMatch) {
      pendingSubject = subMatch[1].replace(/\s+-\s*(?:HSC|Preliminary)?\s*$/, '').trim();
      continue;
    }
  }

  const subjectSet = new Set();
  students.forEach(s => s.subjects.forEach(sub => subjectSet.add(sub.name)));
  const allSubjects = [...subjectSet].sort();

  return { students, allSubjects };
}

function renderTables({ students, allSubjects }) {
  // Table 1
  const rankTable = document.getElementById('rankTable');
  document.getElementById('rankCount').textContent = `${students.length} students ¬∑ ${allSubjects.length} subjects`;

  let html = '<thead><tr><th>Student</th><th class="center">Subjects</th>';
  allSubjects.forEach(s => { html += `<th class="center">${s}</th>`; });
  html += '</tr></thead><tbody>';

  students.forEach(student => {
    const subMap = {};
    student.subjects.forEach(s => { subMap[s.name] = s; });
    html += `<tr><td class="name">${student.name}</td><td class="center">${student.subjects.length}</td>`;
    allSubjects.forEach(subj => {
      const s = subMap[subj];
      if (!s) {
        html += `<td class="center"><span class="pill missing">‚Äî</span></td>`;
      } else {
        const pct = s.rank / s.total;
        const cls = pct <= 0.25 ? 'top' : pct >= 0.75 ? 'bottom' : '';
        html += `<td class="center"><span class="pill ${cls}">${s.rank}/${s.total}</span></td>`;
      }
    });
    html += '</tr>';
  });
  html += '</tbody>';
  rankTable.innerHTML = html;

  // Table 2
  const leaderTable = document.getElementById('leaderTable');

  const withStats = students.map(student => {
    const subs = student.subjects;
    const avg = subs.length ? subs.reduce((acc, s) => acc + s.rank, 0) / subs.length : null;
    return { ...student, avg };
  }).sort((a, b) => (a.avg ?? Infinity) - (b.avg ?? Infinity));

  document.getElementById('boardCount').textContent = 'Sorted by lowest average rank';

  let html2 = `<thead><tr>
    <th class="center">Position</th>
    <th>Student</th>
    <th class="center">Subjects</th>
    <th class="center">Avg Rank</th>`;
  allSubjects.forEach(s => { html2 += `<th class="center">${s}</th>`; });
  html2 += '</tr></thead><tbody>';

  withStats.forEach((student, idx) => {
    const pos = idx + 1;
    const medal = pos === 1 ? 'ü•á' : pos === 2 ? 'ü•à' : pos === 3 ? 'ü•â' : '';
    const posClass = pos === 1 ? 'p1' : pos === 2 ? 'p2' : pos === 3 ? 'p3' : '';
    const rowClass = pos === 1 ? 'gold' : '';
    const subMap = {};
    student.subjects.forEach(s => { subMap[s.name] = s; });

    html2 += `<tr class="${rowClass}">
      <td class="center"><span class="position-badge ${posClass}">${medal || pos}</span></td>
      <td class="name">${student.name}</td>
      <td class="center">${student.subjects.length}</td>
      <td class="center" style="font-weight:500">${student.avg ? student.avg.toFixed(2) : '‚Äî'}</td>`;

    allSubjects.forEach(subj => {
      const s = subMap[subj];
      if (!s) {
        html2 += `<td class="center"><span class="pill missing">‚Äî</span></td>`;
      } else {
        const pct = s.rank / s.total;
        const cls = pct <= 0.25 ? 'top' : pct >= 0.75 ? 'bottom' : '';
        html2 += `<td class="center"><span class="pill ${cls}">${s.rank}/${s.total}</span></td>`;
      }
    });
    html2 += '</tr>';
  });
  html2 += '</tbody>';
  leaderTable.innerHTML = html2;
}

function exportCSV(which) {
  if (!parsedData) return;
  const { students, allSubjects } = parsedData;
  const year = document.getElementById('yearSelect').value;
  let rows = [];

  if (which === 'ranks') {
    rows.push(['Student', 'Subjects Found', ...allSubjects]);
    students.forEach(student => {
      const subMap = {};
      student.subjects.forEach(s => { subMap[s.name] = s; });
      rows.push([
        student.name,
        student.subjects.length,
        ...allSubjects.map(subj => { const s = subMap[subj]; return s ? `${s.rank}/${s.total}` : ''; })
      ]);
    });
  } else {
    const withStats = students.map(student => {
      const subs = student.subjects;
      const avg = subs.length ? subs.reduce((a, s) => a + s.rank, 0) / subs.length : null;
      return { ...student, avg };
    }).sort((a, b) => (a.avg ?? Infinity) - (b.avg ?? Infinity));

    rows.push(['Position', 'Student', 'Subjects Found', 'Avg Rank', ...allSubjects]);
    withStats.forEach((student, idx) => {
      const subMap = {};
      student.subjects.forEach(s => { subMap[s.name] = s; });
      rows.push([
        idx + 1,
        student.name,
        student.subjects.length,
        student.avg ? student.avg.toFixed(2) : '',
        ...allSubjects.map(subj => { const s = subMap[subj]; return s ? `${s.rank}/${s.total}` : ''; })
      ]);
    });
  }

  const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `year${year}-${which}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function resetTool() {
  parsedData = null;
  document.getElementById('results').classList.remove('visible');
  document.getElementById('uploadZone').style.display = '';
  document.getElementById('fileInput').value = '';
  setStatus('');
  setProgress(null);
}
</script>
</body>
</html>
