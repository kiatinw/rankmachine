<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>RankForge</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap');

  :root {
    --ink: #1a1814;
    --paper: #f5f0e8;
    --cream: #ede7d6;
    --accent: #c84b2f;
    --muted: #8a8278;
    --border: rgba(26,24,20,0.15);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    padding: 2rem;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 999;
    opacity: 0.5;
  }

  /* â”€â”€ Masthead â”€â”€ */
  .masthead {
    border-bottom: 2px solid var(--ink);
    padding-bottom: 1rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: flex-start;
    gap: 1.5rem;
    flex-wrap: wrap;
  }

  .masthead-text h1 {
    font-family: 'DM Serif Display', serif;
    font-size: clamp(2rem, 5vw, 3.5rem);
    line-height: 1;
    letter-spacing: -0.02em;
  }

  .masthead-text h1 em { font-style: italic; color: var(--accent); }

  .masthead-text .tagline {
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
    margin-top: 0.3rem;
  }

  /* â”€â”€ Instructions â”€â”€ */
  .instructions {
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1.1rem 1.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.75rem;
    line-height: 1.8;
    color: var(--ink);
  }

  .instructions strong {
    font-weight: 500;
    letter-spacing: 0.05em;
  }

  .instructions .step {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 0.2rem;
    align-items: baseline;
  }

  .instructions .step-num {
    font-family: 'DM Serif Display', serif;
    font-size: 1rem;
    color: var(--accent);
    flex-shrink: 0;
    width: 1rem;
  }

  .instructions summary {
    cursor: pointer;
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    user-select: none;
    list-style: none;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .instructions summary::before {
    content: 'â–¶';
    font-size: 0.5rem;
    transition: transform 0.2s;
  }

  .instructions[open] summary::before { transform: rotate(90deg); }

  .instructions .steps-body { margin-top: 0.75rem; }

  /* â”€â”€ Settings â”€â”€ */
  .settings {
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1.25rem 1.5rem;
    margin-bottom: 1.5rem;
  }

  .settings-grid {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.9rem 1.5rem;
    align-items: start;
  }

  .setting-label-group { display: flex; flex-direction: column; gap: 0.2rem; padding-top: 0.45rem; }

  .setting-label-group label {
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--ink);
    font-weight: 500;
    white-space: nowrap;
  }

  .setting-label-group .hint {
    font-size: 0.65rem;
    color: var(--muted);
    line-height: 1.4;
    max-width: 30ch;
  }

  .setting-control { display: flex; flex-direction: column; gap: 0.2rem; }

  .settings input[type="text"],
  .settings select {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 0.4rem 0.6rem;
    color: var(--ink);
    width: 100%;
    max-width: 380px;
  }

  .settings input[type="text"]:focus,
  .settings select:focus {
    outline: none;
    border-color: var(--accent);
  }

  /* â”€â”€ Upload â”€â”€ */
  .upload-zone {
    border: 2px dashed var(--border);
    background: var(--cream);
    border-radius: 4px;
    padding: 3rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    position: relative;
    margin-bottom: 1.5rem;
  }

  .upload-zone:hover, .upload-zone.drag-over { border-color: var(--accent); background: #f0e8d8; }

  .upload-zone input {
    position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
  }

  .upload-icon { font-size: 2.5rem; margin-bottom: 0.75rem; display: block; }

  .upload-zone h2 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.4rem;
    margin-bottom: 0.4rem;
  }

  .upload-zone p { font-size: 0.75rem; color: var(--muted); letter-spacing: 0.05em; }

  /* â”€â”€ Status / progress â”€â”€ */
  #status {
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    color: var(--muted);
    margin-bottom: 1.5rem;
    min-height: 1.2em;
    text-transform: uppercase;
  }
  #status.error { color: var(--accent); }
  #status.success { color: #2a7a3b; }

  .progress-bar { height: 2px; background: var(--cream); border-radius: 2px; overflow: hidden; margin-bottom: 2rem; display: none; }
  .progress-bar.visible { display: block; }
  .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

  /* â”€â”€ Results â”€â”€ */
  .results { display: none; }
  .results.visible { display: block; }

  /* â”€â”€ Collapsible section â”€â”€ */
  .collapsible-section { margin-bottom: 1.5rem; }

  .collapsible-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: var(--ink);
    color: var(--paper);
    border-radius: 4px 4px 0 0;
    cursor: pointer;
    user-select: none;
    margin-top: 2rem;
  }

  .collapsible-header.collapsed { border-radius: 4px; }

  .collapsible-header h2 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.3rem;
    flex: 1;
  }

  .collapsible-header .count {
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: rgba(245,240,232,0.55);
  }

  .collapse-toggle {
    font-size: 0.6rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: rgba(245,240,232,0.6);
    border: 1px solid rgba(245,240,232,0.25);
    border-radius: 2px;
    padding: 0.2rem 0.5rem;
    flex-shrink: 0;
  }

  .collapsible-body { display: block; }
  .collapsible-body.hidden { display: none; }

  /* â”€â”€ Tables â”€â”€ */
  .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-top: none; border-radius: 0 0 4px 4px; margin-bottom: 0; }

  table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }

  thead tr { background: #2e2b26; color: var(--paper); }

  thead th {
    padding: 0.55rem 0.9rem;
    text-align: left;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-size: 0.62rem;
    white-space: nowrap;
  }

  thead th.center { text-align: center; }

  /* Hidden column styles */
  .col-subjects-list { }
  .col-subjects-list.hide { display: none; }

  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: var(--cream); }
  tbody tr.gold { background: #fdf6e0; }
  tbody tr.gold:hover { background: #f9efcd; }

  td { padding: 0.55rem 0.9rem; vertical-align: middle; }
  td.name { font-family: 'DM Serif Display', serif; font-size: 0.95rem; white-space: nowrap; }
  td.center { text-align: center; font-variant-numeric: tabular-nums; }
  td.subjects-list-cell { font-size: 0.68rem; color: var(--muted); max-width: 260px; line-height: 1.5; }

  .pill {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 2px;
    font-size: 0.72rem;
    background: var(--cream);
    border: 1px solid var(--border);
    white-space: nowrap;
  }
  .pill.top    { background: #d8f0dd; border-color: #9ecba6; color: #1a5c24; }
  .pill.bottom { background: #fde8e3; border-color: #e8b0a2; color: #7a2010; }
  .pill.missing { color: var(--muted); background: transparent; border-color: transparent; font-style: italic; }

  .position-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.8rem;
    height: 1.8rem;
    border-radius: 50%;
    font-size: 0.7rem;
    font-weight: 500;
    background: var(--cream);
    border: 1px solid var(--border);
  }
  .position-badge.p1 { background: #f0d060; border-color: #c9a030; color: #5a3a00; }
  .position-badge.p2 { background: #d8d8d8; border-color: #aaa; color: #333; }
  .position-badge.p3 { background: #e8c498; border-color: #c09060; color: #5a3010; }

  /* â”€â”€ Table toolbar â”€â”€ */
  .table-toolbar {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.5rem 1rem;
    background: #f0ece2;
    border: 1px solid var(--border);
    border-top: none;
    font-size: 0.68rem;
    flex-wrap: wrap;
  }

  .toggle-subjects-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.25rem 0.6rem;
    border: 1px solid var(--border);
    background: var(--paper);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 2px;
    transition: background 0.15s, color 0.15s, border-color 0.15s;
  }

  .toggle-subjects-btn:hover { border-color: var(--ink); color: var(--ink); }
  .toggle-subjects-btn.active { background: var(--ink); color: var(--paper); border-color: var(--ink); }

  /* â”€â”€ Action buttons â”€â”€ */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1.2rem;
    border: 1px solid var(--ink);
    background: var(--ink);
    color: var(--paper);
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 2px;
    transition: background 0.15s, color 0.15s;
  }
  .btn:hover { background: var(--accent); border-color: var(--accent); }
  .btn.secondary { background: transparent; color: var(--ink); }
  .btn.secondary:hover { background: var(--ink); color: var(--paper); }

  .actions { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem; }

  /* â”€â”€ Debug â”€â”€ */
  details.debug { margin-top: 2.5rem; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
  details.debug summary { padding: 0.6rem 1rem; cursor: pointer; font-size: 0.7rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); background: var(--cream); user-select: none; }
  details.debug pre { padding: 1rem; font-size: 0.7rem; line-height: 1.6; white-space: pre-wrap; word-break: break-word; max-height: 300px; overflow-y: auto; background: #fff; }

  footer { margin-top: 3rem; padding-top: 1rem; border-top: 1px solid var(--border); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); text-align: center; }
</style>
</head>
<body>

<div class="masthead">
  <div class="masthead-text">
    <h1>Rank<em>Forge</em></h1>
    <p class="tagline">Parse Â· Rank Â· Compare</p>
  </div>
</div>

<!-- â”€â”€ How to get your PDF â”€â”€ -->
<details class="instructions">
  <summary>How to generate the PDF from Sentral</summary>
  <div class="steps-body">
    <div class="step"><span class="step-num">1</span><span>Log in to Sentral and navigate to <strong>Academic Reports</strong>.</span></div>
    <div class="step"><span class="step-num">2</span><span>Select <strong>Summary Report</strong> from the report type options.</span></div>
    <div class="step"><span class="step-num">3</span><span>Set the year group to the cohort you want to analyse (e.g. Year 12).</span></div>
    <div class="step"><span class="step-num">4</span><span>Under grouping options, select <strong>Group by Student</strong>.</span></div>
    <div class="step"><span class="step-num">5</span><span>Generate and download the PDF, then upload it below.</span></div>
  </div>
</details>

<!-- â”€â”€ Settings â”€â”€ -->
<div class="settings">
  <div class="settings-grid">

    <div class="setting-label-group">
      <label for="yearSelect">Year Group</label>
      <span class="hint">Sets which class codes to recognise. Each subject line contains a code like 12MXX1 â€” selecting Year 12 tells the parser to look for codes starting with 12.</span>
    </div>
    <div class="setting-control">
      <select id="yearSelect">
        <option value="7">Year 7</option>
        <option value="8">Year 8</option>
        <option value="9">Year 9</option>
        <option value="10">Year 10</option>
        <option value="11">Year 11</option>
        <option value="12" selected>Year 12</option>
      </select>
    </div>

    <div class="setting-label-group">
      <label for="scoreMode">Score mode</label>
      <span class="hint">Choose whether your reports show a <strong>rank</strong> (e.g. 17/61) or a <strong>percentage mark</strong> (e.g. 87%). Years 11â€“12 typically use ranks; Years 7â€“10 typically use percentage marks. This also changes how the leaderboard is sorted.</span>
    </div>
    <div class="setting-control">
      <select id="scoreMode" onchange="onScoreModeChange()">
        <option value="rank">Rank (e.g. 17/61) â€” sort by lowest</option>
        <option value="percent">Percentage mark (e.g. 87%) â€” sort by highest</option>
      </select>
    </div>

    <div class="setting-label-group">
      <label for="rankKey" id="rankKeyLabel">Rank search key</label>
      <span class="hint" id="rankKeyHint">The text that appears just before the score in the PDF. RankForge scans each line for this phrase and extracts the number that follows it. Change this if your reports use different wording.</span>
    </div>
    <div class="setting-control">
      <input type="text" id="rankKey" value="Overall Assessment Rank" placeholder="e.g. Overall Assessment Rank" />
    </div>

  </div>
</div>

<!-- â”€â”€ Upload â”€â”€ -->
<div class="upload-zone" id="uploadZone">
  <input type="file" id="fileInput" accept=".pdf" />
  <span class="upload-icon">ğŸ“„</span>
  <h2>Drop your PDF here</h2>
  <p>or click to browse â€” no data leaves your device</p>
</div>

<div id="status"></div>
<div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>

<!-- â”€â”€ Results â”€â”€ -->
<div class="results" id="results">

  <div class="actions">
    <button class="btn" onclick="exportCSV('ranks')">â¬‡ Export ranks CSV</button>
    <button class="btn" onclick="exportCSV('best')">â¬‡ Export leaderboard CSV</button>
    <button class="btn secondary" onclick="resetTool()">â†º Load another PDF</button>
  </div>

  <!-- Table 1 -->
  <div class="collapsible-section">
    <div class="collapsible-header" id="header1" onclick="toggleSection('body1','header1','toggle1')">
      <h2>Subject Ranks by Student</h2>
      <span class="count" id="rankCount"></span>
      <span class="collapse-toggle" id="toggle1">collapse â–²</span>
    </div>
    <div class="collapsible-body" id="body1">
      <div class="table-toolbar">
        <button class="toggle-subjects-btn" id="subjectsToggle1" onclick="toggleSubjectsList(1)">â˜° Show subject list column</button>
      </div>
      <div class="table-wrap"><table id="rankTable"></table></div>
    </div>
  </div>

  <!-- Table 2 -->
  <div class="collapsible-section">
    <div class="collapsible-header" id="header2" onclick="toggleSection('body2','header2','toggle2')">
      <h2>Overall Leaderboard</h2>
      <span class="count" id="boardCount"></span>
      <span class="collapse-toggle" id="toggle2">collapse â–²</span>
    </div>
    <div class="collapsible-body" id="body2">
      <div class="table-toolbar">
        <button class="toggle-subjects-btn" id="subjectsToggle2" onclick="toggleSubjectsList(2)">â˜° Show subject list column</button>
      </div>
      <div class="table-wrap"><table id="leaderTable"></table></div>
    </div>
  </div>

  <details class="debug">
    <summary>ğŸ” Debug â€” raw extracted text</summary>
    <pre id="rawText"></pre>
  </details>

</div>

<footer>RankForge &mdash; Client-side only &mdash; PDF.js &mdash; No data transmitted</footer>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let parsedData = null;
// Track subject list column visibility per table
const subjectsVisible = { 1: false, 2: false };

// â”€â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const zone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');

zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
zone.addEventListener('drop', e => {
  e.preventDefault();
  zone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file && file.type === 'application/pdf') handleFile(file);
  else setStatus('Please drop a PDF file.', 'error');
});
fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

function setStatus(msg, type = '') {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.className = type;
}

function setProgress(pct) {
  const bar = document.getElementById('progressBar');
  const fill = document.getElementById('progressFill');
  if (pct === null) { bar.classList.remove('visible'); return; }
  bar.classList.add('visible');
  fill.style.width = pct + '%';
}

// â”€â”€â”€ Collapsible sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSection(bodyId, headerId, toggleId) {
  const body = document.getElementById(bodyId);
  const header = document.getElementById(headerId);
  const toggle = document.getElementById(toggleId);
  const isCollapsed = body.classList.contains('hidden');
  body.classList.toggle('hidden');
  header.classList.toggle('collapsed', !isCollapsed);
  toggle.textContent = isCollapsed ? 'collapse â–²' : 'expand â–¼';
}

// â”€â”€â”€ Subject list column toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSubjectsList(tableNum) {
  subjectsVisible[tableNum] = !subjectsVisible[tableNum];
  const visible = subjectsVisible[tableNum];
  const btn = document.getElementById(`subjectsToggle${tableNum}`);
  btn.textContent = visible ? 'â˜° Hide subject list column' : 'â˜° Show subject list column';
  btn.classList.toggle('active', visible);
  const tableId = tableNum === 1 ? 'rankTable' : 'leaderTable';
  const table = document.getElementById(tableId);
  table.querySelectorAll('.col-subjects-list').forEach(el => {
    el.classList.toggle('hide', !visible);
  });
}

// â”€â”€â”€ PDF extraction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleFile(file) {
  setStatus('Loading PDFâ€¦');
  setProgress(5);

  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  const totalPages = pdf.numPages;

  let fullText = '';
  for (let i = 1; i <= totalPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();

    const items = content.items.slice().sort((a, b) => {
      const dy = b.transform[5] - a.transform[5];
      return Math.abs(dy) > 3 ? dy : a.transform[4] - b.transform[4];
    });

    const lines = [];
    let lastY = null;
    let line = [];
    for (const item of items) {
      const y = Math.round(item.transform[5]);
      if (lastY !== null && Math.abs(y - lastY) > 3) {
        if (line.length) lines.push(line.join(' '));
        line = [];
      }
      if (item.str.trim()) line.push(item.str.trim());
      lastY = y;
    }
    if (line.length) lines.push(line.join(' '));

    fullText += lines.join('\n') + '\n--- PAGE BREAK ---\n';
    setProgress(5 + Math.round((i / totalPages) * 60));
  }

  document.getElementById('rawText').textContent = fullText;
  setProgress(70);
  setStatus('Parsing student dataâ€¦');

  const year = document.getElementById('yearSelect').value;
  const rankKey = document.getElementById('rankKey').value.trim() || 'Overall Assessment Rank';
  const scoreMode = document.getElementById('scoreMode').value;
  parsedData = parseText(fullText, year, rankKey, scoreMode);
  setProgress(90);

  if (!parsedData.students.length) {
    setStatus('No student data found. Check the debug panel below to see extracted text.', 'error');
    document.getElementById('results').classList.add('visible');
    setProgress(null);
    return;
  }

  // Reset subject list toggles
  subjectsVisible[1] = false;
  subjectsVisible[2] = false;
  document.getElementById('subjectsToggle1').classList.remove('active');
  document.getElementById('subjectsToggle2').classList.remove('active');
  document.getElementById('subjectsToggle1').textContent = 'â˜° Show subject list column';
  document.getElementById('subjectsToggle2').textContent = 'â˜° Show subject list column';

  renderTables(parsedData);
  setProgress(null);
  setStatus(`âœ“ Found ${parsedData.students.length} students across ${parsedData.allSubjects.length} subjects.`, 'success');
  document.getElementById('results').classList.add('visible');
  document.getElementById('uploadZone').style.display = 'none';
}

// â”€â”€â”€ Parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseText(text, year, rankKey, scoreMode) {
  const lines = text.split('\n').map(l => l.trim()).filter(Boolean);

  const studentRe = /^([A-Z][A-Z'\-]+(?:\s+[A-Z][A-Z'\-]+)*,\s+[A-Z][a-zA-Z'\-]+(?:\s+[A-Z][a-zA-Z'\-]*)*)\s+Semester\b/;

  const escapedYear = year.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const subjectRe = new RegExp(`^(.+?)(?:\\s+-\\s+(?:HSC|Preliminary)?)?\\s+${escapedYear}[A-Z]{2,}[\\dA-Z]*`);

  const escapedKey = rankKey.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  // Rank mode: matches "Key: 17/61"
  // Percent mode: matches "Key: 87%" or "Key: 87 %"
  const rankRe   = new RegExp(`${escapedKey}[:\\s]+(\\d+)\\s*\\/\\s*(\\d+)`, 'i');
  const percentRe = new RegExp(`${escapedKey}[:\\s]+(\\d+(?:\\.\\d+)?)\\s*%`, 'i');

  const students = [];
  let curStudent = null;
  let pendingSubject = null;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (line.includes('--- PAGE BREAK ---')) continue;

    const studentMatch = line.match(studentRe);
    if (studentMatch) {
      curStudent = { name: studentMatch[1].trim(), subjects: [] };
      students.push(curStudent);
      pendingSubject = null;
      continue;
    }

    if (!curStudent) continue;

    if (scoreMode === 'percent') {
      const pctMatch = line.match(percentRe);
      if (pctMatch) {
        const pct = parseFloat(pctMatch[1]);
        if (pendingSubject) {
          curStudent.subjects.push({ name: pendingSubject, score: pct });
          pendingSubject = null;
        }
        continue;
      }
    } else {
      const rankMatch = line.match(rankRe);
      if (rankMatch) {
        const rank = parseInt(rankMatch[1]);
        const total = parseInt(rankMatch[2]);
        if (pendingSubject) {
          curStudent.subjects.push({ name: pendingSubject, rank, total });
          pendingSubject = null;
        }
        continue;
      }
    }

    const subMatch = line.match(subjectRe);
    if (subMatch) {
      pendingSubject = subMatch[1].replace(/\s+-\s*(?:HSC|Preliminary)?\s*$/, '').trim();
      continue;
    }
  }

  const subjectSet = new Set();
  students.forEach(s => s.subjects.forEach(sub => subjectSet.add(sub.name)));
  const allSubjects = [...subjectSet].sort();

  return { students, allSubjects, scoreMode };
}

// â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTables({ students, allSubjects, scoreMode }) {
  const isPercent = scoreMode === 'percent';

  // Helper: get display value and CSS class for a subject entry
  function pillFor(s) {
    if (!s) return '<span class="pill missing">â€”</span>';
    if (isPercent) {
      const pct = s.score;
      const cls = pct >= 80 ? 'top' : pct < 50 ? 'bottom' : '';
      return `<span class="pill ${cls}">${pct.toFixed(1)}%</span>`;
    } else {
      const ratio = s.rank / s.total;
      const cls = ratio <= 0.25 ? 'top' : ratio >= 0.75 ? 'bottom' : '';
      return `<span class="pill ${cls}">${s.rank}/${s.total}</span>`;
    }
  }

  // â”€â”€ Table 1 â”€â”€
  const rankTable = document.getElementById('rankTable');
  document.getElementById('rankCount').textContent = `${students.length} students Â· ${allSubjects.length} subjects`;

  const scoreColLabel = isPercent ? 'Avg %' : 'Avg Rank';

  let html = `<thead><tr>
    <th>Student</th>
    <th class="center col-subjects-list hide">Subjects</th>
    <th class="center">Subjects Found</th>`;
  allSubjects.forEach(s => { html += `<th class="center">${s}</th>`; });
  html += '</tr></thead><tbody>';

  students.forEach(student => {
    const subMap = {};
    student.subjects.forEach(s => { subMap[s.name] = s; });
    const subjectListStr = student.subjects.map(s => s.name).join(', ');
    html += `<tr>
      <td class="name">${student.name}</td>
      <td class="subjects-list-cell col-subjects-list hide">${subjectListStr || 'â€”'}</td>
      <td class="center">${student.subjects.length}</td>`;
    allSubjects.forEach(subj => {
      html += `<td class="center">${pillFor(subMap[subj])}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody>';
  rankTable.innerHTML = html;

  // â”€â”€ Table 2: leaderboard â”€â”€
  const leaderTable = document.getElementById('leaderTable');

  const withStats = students.map(student => {
    const subs = student.subjects;
    let avg = null;
    if (subs.length) {
      if (isPercent) {
        avg = subs.reduce((acc, s) => acc + s.score, 0) / subs.length;
      } else {
        avg = subs.reduce((acc, s) => acc + s.rank, 0) / subs.length;
      }
    }
    return { ...student, avg };
  }).sort((a, b) => {
    if (a.avg === null) return 1;
    if (b.avg === null) return -1;
    // Percent: higher is better (descending). Rank: lower is better (ascending).
    return isPercent ? b.avg - a.avg : a.avg - b.avg;
  });

  document.getElementById('boardCount').textContent = isPercent
    ? 'Sorted by highest average mark'
    : 'Sorted by lowest average rank';

  let html2 = `<thead><tr>
    <th class="center">Position</th>
    <th>Student</th>
    <th class="center col-subjects-list hide">Subjects</th>
    <th class="center">Subjects Found</th>
    <th class="center">${scoreColLabel}</th>`;
  allSubjects.forEach(s => { html2 += `<th class="center">${s}</th>`; });
  html2 += '</tr></thead><tbody>';

  withStats.forEach((student, idx) => {
    const pos = idx + 1;
    const medal = pos === 1 ? 'ğŸ¥‡' : pos === 2 ? 'ğŸ¥ˆ' : pos === 3 ? 'ğŸ¥‰' : '';
    const posClass = pos === 1 ? 'p1' : pos === 2 ? 'p2' : pos === 3 ? 'p3' : '';
    const rowClass = pos === 1 ? 'gold' : '';
    const subMap = {};
    student.subjects.forEach(s => { subMap[s.name] = s; });
    const subjectListStr = student.subjects.map(s => s.name).join(', ');
    const avgDisplay = student.avg !== null
      ? (isPercent ? student.avg.toFixed(1) + '%' : student.avg.toFixed(2))
      : 'â€”';

    html2 += `<tr class="${rowClass}">
      <td class="center"><span class="position-badge ${posClass}">${medal || pos}</span></td>
      <td class="name">${student.name}</td>
      <td class="subjects-list-cell col-subjects-list hide">${subjectListStr || 'â€”'}</td>
      <td class="center">${student.subjects.length}</td>
      <td class="center" style="font-weight:500">${avgDisplay}</td>`;

    allSubjects.forEach(subj => {
      html2 += `<td class="center">${pillFor(subMap[subj])}</td>`;
    });
    html2 += '</tr>';
  });
  html2 += '</tbody>';
  leaderTable.innerHTML = html2;
}

// â”€â”€â”€ CSV Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV(which) {
  if (!parsedData) return;
  const { students, allSubjects, scoreMode } = parsedData;
  const isPercent = scoreMode === 'percent';
  const year = document.getElementById('yearSelect').value;
  const scoreLabel = isPercent ? 'Avg %' : 'Avg Rank';
  let rows = [];

  function scoreStr(s) {
    if (!s) return '';
    return isPercent ? s.score.toFixed(1) + '%' : `${s.rank}/${s.total}`;
  }

  if (which === 'ranks') {
    rows.push(['Student', 'Subjects', 'Subjects Found', ...allSubjects]);
    students.forEach(student => {
      const subMap = {};
      student.subjects.forEach(s => { subMap[s.name] = s; });
      rows.push([
        student.name,
        student.subjects.map(s => s.name).join('; '),
        student.subjects.length,
        ...allSubjects.map(subj => scoreStr(subMap[subj]))
      ]);
    });
  } else {
    const withStats = students.map(student => {
      const subs = student.subjects;
      let avg = null;
      if (subs.length) {
        avg = isPercent
          ? subs.reduce((a, s) => a + s.score, 0) / subs.length
          : subs.reduce((a, s) => a + s.rank, 0) / subs.length;
      }
      return { ...student, avg };
    }).sort((a, b) => {
      if (a.avg === null) return 1;
      if (b.avg === null) return -1;
      return isPercent ? b.avg - a.avg : a.avg - b.avg;
    });

    rows.push(['Position', 'Student', 'Subjects', 'Subjects Found', scoreLabel, ...allSubjects]);
    withStats.forEach((student, idx) => {
      const subMap = {};
      student.subjects.forEach(s => { subMap[s.name] = s; });
      const avgDisplay = student.avg !== null
        ? (isPercent ? student.avg.toFixed(1) + '%' : student.avg.toFixed(2))
        : '';
      rows.push([
        idx + 1,
        student.name,
        student.subjects.map(s => s.name).join('; '),
        student.subjects.length,
        avgDisplay,
        ...allSubjects.map(subj => scoreStr(subMap[subj]))
      ]);
    });
  }

  const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `rankforge-year${year}-${which}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// â”€â”€â”€ Score mode change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onScoreModeChange() {
  const isPercent = document.getElementById('scoreMode').value === 'percent';
  const label = document.getElementById('rankKeyLabel');
  const input = document.getElementById('rankKey');
  if (isPercent) {
    label.textContent = 'Mark search key';
    input.placeholder = 'e.g. Assessment Mark';
    if (input.value === 'Overall Assessment Rank') input.value = 'Assessment Mark';
  } else {
    label.textContent = 'Rank search key';
    input.placeholder = 'e.g. Overall Assessment Rank';
    if (input.value === 'Assessment Mark') input.value = 'Overall Assessment Rank';
  }
}

// â”€â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetTool() {
  parsedData = null;
  document.getElementById('results').classList.remove('visible');
  document.getElementById('uploadZone').style.display = '';
  document.getElementById('fileInput').value = '';
  setStatus('');
  setProgress(null);
  // Re-expand sections for next use
  ['body1','body2'].forEach(id => document.getElementById(id).classList.remove('hidden'));
  ['header1','header2'].forEach(id => document.getElementById(id).classList.remove('collapsed'));
  document.getElementById('toggle1').textContent = 'collapse â–²';
  document.getElementById('toggle2').textContent = 'collapse â–²';
}
</script>
</body>
</html>
