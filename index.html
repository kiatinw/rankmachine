<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RankForge</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap');

:root {
  --ink: #1a1814; --paper: #f5f0e8; --cream: #ede7d6;
  --accent: #c84b2f; --muted: #8a8278; --border: rgba(26,24,20,0.15);
  --gt-bg: #f0e8f8; --gt-border: #c0a0d8;
  --top30-bg: #fdf2cc; --top30-border: #e8c840;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Mono',monospace;background:var(--paper);color:var(--ink);min-height:100vh;padding:2rem}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:999;opacity:.5;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E")}

/* Masthead */
.masthead{border-bottom:2px solid var(--ink);padding-bottom:1rem;margin-bottom:2rem}
.masthead h1{font-family:'DM Serif Display',serif;font-size:clamp(3rem,7vw,6rem);line-height:1;letter-spacing:-.02em}
.masthead h1 em{font-style:italic;color:var(--accent)}
.masthead .tagline{font-size:1rem;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);margin-top:.3rem}

/* Panels */
.panel{background:var(--cream);border:1px solid var(--border);border-radius:4px;margin-bottom:1.5rem;overflow:hidden}
.panel-header{display:flex;align-items:center;gap:.75rem;padding:.75rem 1.25rem;cursor:pointer;user-select:none}
.panel-header h3{font-family:'DM Serif Display',serif;font-size:1.1rem;flex:1}
.panel-arrow{font-size:.55rem;color:var(--muted);transition:transform .2s}
.panel-header.open .panel-arrow{transform:rotate(90deg)}
.panel-body{padding:0 1.25rem 1.25rem;display:none}
.panel-body.open{display:block}
.step{display:flex;gap:.75rem;margin-bottom:.3rem;align-items:baseline;font-size:.75rem;line-height:1.7}
.step-num{font-family:'DM Serif Display',serif;font-size:1rem;color:var(--accent);flex-shrink:0;width:1rem}

/* Settings */
.settings{background:var(--cream);border:1px solid var(--border);border-radius:4px;padding:1.25rem 1.5rem;margin-bottom:1.5rem}
.settings-grid{display:grid;grid-template-columns:auto 1fr;gap:.9rem 1.5rem;align-items:start}
.setting-label-group{display:flex;flex-direction:column;gap:.2rem;padding-top:.45rem}
.setting-label-group label{font-size:.7rem;letter-spacing:.1em;text-transform:uppercase;color:var(--ink);font-weight:500;white-space:nowrap}
.setting-label-group .hint{font-size:.65rem;color:var(--muted);line-height:1.4;max-width:34ch}
.setting-control{display:flex;flex-direction:column;gap:.2rem}
.settings input[type=text],.settings select{font-family:'DM Mono',monospace;font-size:.8rem;background:var(--paper);border:1px solid var(--border);border-radius:2px;padding:.4rem .6rem;color:var(--ink);width:100%;max-width:380px}
.settings input[type=text]:focus,.settings select:focus{outline:none;border-color:var(--accent)}

/* â”€â”€ Penalty panel â”€â”€ */
.penalty-section-label{font-size:.65rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);padding-bottom:.4rem;margin:1.2rem 0 .6rem;font-weight:500}
.penalty-controls{display:flex;align-items:center;gap:1rem;margin-bottom:1rem;flex-wrap:wrap;padding-bottom:.75rem;border-bottom:1px solid var(--border)}
.penalty-mode-label{font-size:.68rem;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
.seg-control{display:flex;border:1px solid var(--border);border-radius:3px;overflow:hidden}
.seg-control button{font-family:'DM Mono',monospace;font-size:.68rem;letter-spacing:.07em;text-transform:uppercase;padding:.3rem .8rem;background:var(--paper);border:none;cursor:pointer;color:var(--muted);transition:background .15s,color .15s}
.seg-control button.active{background:var(--ink);color:var(--paper)}
.seg-control button:not(:last-child){border-right:1px solid var(--border)}
.category-legend{display:flex;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap;font-size:.68rem}
.cat-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;border-radius:2px;border:1px solid var(--border);cursor:default}
.cat-badge.easy{background:#e8f4e8;border-color:#a8d0a8;color:#2a5a2a}
.cat-badge.normal{background:var(--cream)}
.cat-badge.hard{background:#e8eef8;border-color:#a8b8d8;color:#1a2a5a}

.penalty-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:.5rem}
.penalty-row{display:flex;align-items:center;gap:.6rem;padding:.4rem .6rem;background:var(--paper);border:1px solid var(--border);border-radius:3px}
.penalty-subject-name{flex:1;font-size:.72rem;line-height:1.3}
.gt-badge{font-size:.58rem;letter-spacing:.06em;text-transform:uppercase;padding:.1rem .35rem;border-radius:2px;background:var(--gt-bg);border:1px solid var(--gt-border);color:#5a2a8a;flex-shrink:0}
.penalty-row input[type=number]{font-family:'DM Mono',monospace;font-size:.75rem;width:5rem;background:var(--cream);border:1px solid var(--border);border-radius:2px;padding:.25rem .4rem;color:var(--ink);text-align:right}
.penalty-row input[type=number]:focus{outline:none;border-color:var(--accent)}
.cat-select{font-family:'DM Mono',monospace;font-size:.7rem;background:var(--cream);border:1px solid var(--border);border-radius:2px;padding:.25rem .3rem;color:var(--ink);cursor:pointer}
.cat-select:focus{outline:none;border-color:var(--accent)}
.penalty-apply-btn{margin-top:1rem;font-family:'DM Mono',monospace;font-size:.7rem;letter-spacing:.1em;text-transform:uppercase;padding:.45rem 1rem;background:var(--ink);color:var(--paper);border:none;border-radius:2px;cursor:pointer;transition:background .15s}
.penalty-apply-btn:hover{background:var(--accent)}

/* â”€â”€ Maths grouping â”€â”€ */
.maths-group-area{margin-top:.5rem}
.maths-group-controls{display:flex;gap:.5rem;align-items:center;margin-bottom:.75rem;flex-wrap:wrap}
.add-group-btn{font-family:'DM Mono',monospace;font-size:.68rem;letter-spacing:.08em;text-transform:uppercase;padding:.3rem .7rem;background:transparent;border:1px solid var(--border);border-radius:2px;cursor:pointer;color:var(--muted);transition:all .15s}
.add-group-btn:hover{border-color:var(--ink);color:var(--ink)}
.maths-groups-container{display:flex;gap:.75rem;flex-wrap:wrap;align-items:flex-start}
.maths-group-col{background:var(--paper);border:1px solid var(--border);border-radius:4px;min-width:180px;max-width:240px;flex:1}
.maths-group-header{display:flex;align-items:center;gap:.4rem;padding:.5rem .6rem;border-bottom:1px solid var(--border);background:var(--cream)}
.maths-group-name-input{font-family:'DM Serif Display',serif;font-size:.9rem;border:none;background:transparent;color:var(--ink);flex:1;min-width:0;padding:0}
.maths-group-name-input:focus{outline:none;border-bottom:1px solid var(--accent)}
.remove-group-btn{font-size:.7rem;background:none;border:none;cursor:pointer;color:var(--muted);padding:.1rem .3rem;line-height:1}
.remove-group-btn:hover{color:var(--accent)}
.maths-drop-zone{min-height:48px;padding:.4rem;display:flex;flex-direction:column;gap:.3rem}
.maths-drop-zone.drag-over{background:#f0e8d8;border-radius:2px}
.maths-class-chip{padding:.25rem .5rem;background:var(--cream);border:1px solid var(--border);border-radius:2px;font-size:.68rem;cursor:grab;user-select:none;display:flex;align-items:center;gap:.3rem}
.maths-class-chip:active{cursor:grabbing;opacity:.7}
.maths-class-chip .chip-remove{background:none;border:none;cursor:pointer;color:var(--muted);font-size:.7rem;line-height:1;padding:0 .1rem;margin-left:auto}
.maths-class-chip .chip-remove:hover{color:var(--accent)}
.maths-unassigned{background:var(--paper);border:1px solid var(--border);border-radius:4px;min-width:180px;flex:1;max-width:260px}
.maths-unassigned-header{padding:.5rem .6rem;border-bottom:1px solid var(--border);background:#fde8e3;font-size:.68rem;letter-spacing:.08em;text-transform:uppercase;color:var(--accent)}

/* Upload */
.upload-zone{border:2px dashed var(--border);background:var(--cream);border-radius:4px;padding:3rem 2rem;text-align:center;cursor:pointer;transition:border-color .2s,background .2s;position:relative;margin-bottom:1.5rem}
.upload-zone:hover,.upload-zone.drag-over{border-color:var(--accent);background:#f0e8d8}
.upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.upload-icon{font-size:2.5rem;margin-bottom:.75rem;display:block}
.upload-zone h2{font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:.4rem}
.upload-zone p{font-size:.75rem;color:var(--muted);letter-spacing:.05em}

/* Status */
#status{font-size:.75rem;letter-spacing:.08em;color:var(--muted);margin-bottom:1.5rem;min-height:1.2em;text-transform:uppercase}
#status.error{color:var(--accent)}
#status.success{color:#2a7a3b}
.progress-bar{height:2px;background:var(--cream);border-radius:2px;overflow:hidden;margin-bottom:2rem;display:none}
.progress-bar.visible{display:block}
.progress-fill{height:100%;background:var(--accent);width:0%;transition:width .3s}

/* Results */
.results{display:none}
.results.visible{display:block}

/* Collapsible table sections */
.collapsible-section{margin-bottom:1.5rem}
.collapsible-header{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;background:var(--ink);color:var(--paper);border-radius:4px 4px 0 0;cursor:pointer;user-select:none;margin-top:2rem}
.collapsible-header.collapsed{border-radius:4px}
.collapsible-header h2{font-family:'DM Serif Display',serif;font-size:1.3rem;flex:1}
.collapsible-header .count{font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;color:rgba(245,240,232,.55)}
.collapse-toggle{font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;color:rgba(245,240,232,.6);border:1px solid rgba(245,240,232,.25);border-radius:2px;padding:.2rem .5rem}
.collapsible-body{display:block}
.collapsible-body.hidden{display:none}

/* Tables */
.table-wrap{overflow-x:auto;border:1px solid var(--border);border-top:none;border-radius:0 0 4px 4px}
table{width:100%;border-collapse:collapse;font-size:.78rem}
thead tr{background:#2e2b26;color:var(--paper)}
thead th{padding:.55rem .9rem;text-align:left;font-weight:500;letter-spacing:.08em;text-transform:uppercase;font-size:.62rem;white-space:nowrap}
thead th.center{text-align:center}
.col-subjects-list.hide{display:none}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:var(--cream)}
tbody tr.gold{background:#fdf6e0}
tbody tr.gold:hover{background:#f9efcd}
tbody tr.top30{background:var(--top30-bg) !important}
tbody tr.top30:hover{background:#faedb0 !important}
td{padding:.55rem .9rem;vertical-align:middle}
td.name{font-family:'DM Serif Display',serif;font-size:.95rem;white-space:nowrap}
td.center{text-align:center;font-variant-numeric:tabular-nums}
td.subjects-list-cell{font-size:.68rem;color:var(--muted);max-width:260px;line-height:1.5}

.pill{display:inline-block;padding:.15rem .5rem;border-radius:2px;font-size:.72rem;background:var(--cream);border:1px solid var(--border);white-space:nowrap}
.pill.top{background:#d8f0dd;border-color:#9ecba6;color:#1a5c24}
.pill.bottom{background:#fde8e3;border-color:#e8b0a2;color:#7a2010}
.pill.missing{color:var(--muted);background:transparent;border-color:transparent;font-style:italic}
.pill.gt{background:var(--gt-bg);border-color:var(--gt-border)}

.position-badge{display:inline-flex;align-items:center;justify-content:center;width:1.8rem;height:1.8rem;border-radius:50%;font-size:.7rem;font-weight:500;background:var(--cream);border:1px solid var(--border)}
.position-badge.p1{background:#f0d060;border-color:#c9a030;color:#5a3a00}
.position-badge.p2{background:#d8d8d8;border-color:#aaa;color:#333}
.position-badge.p3{background:#e8c498;border-color:#c09060;color:#5a3010}
.position-badge.top30{background:var(--top30-bg);border-color:var(--top30-border)}

.has-tip{position:relative;cursor:help;border-bottom:1px dashed var(--muted)}
.has-tip:hover::after{content:attr(data-tip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--ink);color:var(--paper);font-size:.65rem;padding:.3rem .6rem;border-radius:3px;white-space:nowrap;pointer-events:none;margin-bottom:4px;z-index:10}

.table-toolbar{display:flex;align-items:center;gap:1rem;padding:.5rem 1rem;background:#f0ece2;border:1px solid var(--border);border-top:none;flex-wrap:wrap}
.toggle-subjects-btn{display:inline-flex;align-items:center;gap:.3rem;padding:.25rem .6rem;border:1px solid var(--border);background:var(--paper);color:var(--muted);font-family:'DM Mono',monospace;font-size:.65rem;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;border-radius:2px;transition:all .15s}
.toggle-subjects-btn:hover{border-color:var(--ink);color:var(--ink)}
.toggle-subjects-btn.active{background:var(--ink);color:var(--paper);border-color:var(--ink)}

.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.5rem 1.2rem;border:1px solid var(--ink);background:var(--ink);color:var(--paper);font-family:'DM Mono',monospace;font-size:.72rem;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;border-radius:2px;transition:background .15s,color .15s}
.btn:hover{background:var(--accent);border-color:var(--accent)}
.btn.secondary{background:transparent;color:var(--ink)}
.btn.secondary:hover{background:var(--ink);color:var(--paper)}
.actions{display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:1.5rem}

details.debug{margin-top:2.5rem;border:1px solid var(--border);border-radius:4px;overflow:hidden}
details.debug summary{padding:.6rem 1rem;cursor:pointer;font-size:.7rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);background:var(--cream);user-select:none}
details.debug pre{padding:1rem;font-size:.7rem;line-height:1.6;white-space:pre-wrap;word-break:break-word;max-height:300px;overflow-y:auto;background:#fff}
footer{margin-top:3rem;padding-top:1rem;border-top:1px solid var(--border);font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);text-align:center}
</style>
</head>
<body>

<div class="masthead" style="text-align: center;">
  <h1>Rank<em>Forge</em></h1>
  <p class="tagline">Parse Â· Rank Â· Compare</p>
</div>

<!-- Instructions -->
<div class="panel">
  <div class="panel-header" onclick="togglePanel(this)">
    <h3>How to generate the PDF from Sentral</h3>
    <span class="panel-arrow">â–¶</span>
  </div>
  <div class="panel-body">
    <div class="step"><span class="step-num">1</span><span>Log in to Sentral and navigate to <strong>Academic Reports</strong>.</span></div>
    <div class="step"><span class="step-num">2</span><span>Select <strong>Summary Report</strong> from the report type options.</span></div>
    <div class="step"><span class="step-num">3</span><span>Set the year group to the cohort you want to analyse.</span></div>
    <div class="step"><span class="step-num">4</span><span>Under grouping options, select <strong>Group by Student</strong>.</span></div>
    <div class="step"><span class="step-num">5</span><span>Generate and download the PDF, then upload it below.</span></div>
  </div>
</div>

<!-- Settings -->
<div class="settings">
  <div class="settings-grid">
    <div class="setting-label-group">
      <label for="yearSelect">Year Group</label>
      <span class="hint">Sets which class codes to recognise. Selecting Year 7â€“10 also enables maths grouping and G&T class detection.</span>
    </div>
    <div class="setting-control">
      <select id="yearSelect" onchange="onYearChange()">
        <option value="7">Year 7</option>
        <option value="8">Year 8</option>
        <option value="9">Year 9</option>
        <option value="10">Year 10</option>
        <option value="11">Year 11</option>
        <option value="12" selected>Year 12</option>
      </select>
    </div>
    <div class="setting-label-group">
      <label for="scoreMode">Score mode</label>
      <span class="hint">Rank mode extracts X/Y ranks. Percentage mode extracts % marks and compares via z-scores relative to the cohort per subject.</span>
    </div>
    <div class="setting-control">
      <select id="scoreMode" onchange="onScoreModeChange()">
        <option value="rank">Rank (e.g. 17/61) â€” sort by lowest</option>
        <option value="percent">Percentage mark (e.g. 87%) â€” z-score comparison</option>
      </select>
    </div>
    <div class="setting-label-group">
      <label for="rankKey" id="rankKeyLabel">Rank search key</label>
      <span class="hint" id="rankKeyHint">The text just before the score in the PDF. Change if your reports use different wording.</span>
    </div>
    <div class="setting-control">
      <input type="text" id="rankKey" value="Overall Assessment Rank" placeholder="e.g. Overall Assessment Rank"/>
    </div>
  </div>
</div>

<!-- Upload -->
<div class="upload-zone" id="uploadZone">
  <input type="file" id="fileInput" accept=".pdf"/>
  <span class="upload-icon">ğŸ“„</span>
  <h2>Drop your PDF here</h2>
  <p>or click to browse â€” no data leaves your device</p>
</div>

<div id="status"></div>
<div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>

<!-- Results -->
<div class="results" id="results">
  <div class="actions">
    <button class="btn" onclick="exportCSV('ranks')">â¬‡ Export scores CSV</button>
    <button class="btn" onclick="exportCSV('best')">â¬‡ Export leaderboard CSV</button>
    <button class="btn secondary" onclick="resetTool()">â†º Load another PDF</button>
  </div>

  <!-- Weighting + grouping panel -->
  <div class="panel" id="penaltyPanel" style="display:none">
    <div class="panel-header" onclick="togglePanel(this)">
      <h3>Subject Weighting &amp; Maths Grouping</h3>
      <span class="panel-arrow">â–¶</span>
    </div>
    <div class="panel-body" id="penaltyBody">
      <!-- dynamic content injected here -->
    </div>
  </div>

  <!-- Table 1: all students -->
  <div class="collapsible-section">
    <div class="collapsible-header" id="header1" onclick="toggleSection('body1','header1','toggle1')">
      <h2>Subject Scores by Student</h2>
      <span class="count" id="rankCount"></span>
      <span class="collapse-toggle" id="toggle1">collapse â–²</span>
    </div>
    <div class="collapsible-body" id="body1">
      <div class="table-toolbar">
        <button class="toggle-subjects-btn" id="subjectsToggle1" onclick="toggleSubjectsList(1)">â˜° Show subject list column</button>
      </div>
      <div class="table-wrap"><table id="rankTable"></table></div>
    </div>
  </div>

  <!-- Table 2: leaderboard -->
  <div class="collapsible-section">
    <div class="collapsible-header" id="header2" onclick="toggleSection('body2','header2','toggle2')">
      <h2>Overall Leaderboard</h2>
      <span class="count" id="boardCount"></span>
      <span class="collapse-toggle" id="toggle2">collapse â–²</span>
    </div>
    <div class="collapsible-body" id="body2">
      <div class="table-toolbar">
        <button class="toggle-subjects-btn" id="subjectsToggle2" onclick="toggleSubjectsList(2)">â˜° Show subject list column</button>
      </div>
      <div class="table-wrap"><table id="leaderTable"></table></div>
    </div>
  </div>

  <!-- Table 3: Top 30 (Years 7-10 only) -->
  <div class="collapsible-section" id="top30Section" style="display:none">
    <div class="collapsible-header" id="header3" onclick="toggleSection('body3','header3','toggle3')" style="background:#b8960a">
      <h2>Top 30</h2>
      <span class="count" id="top30Count"></span>
      <span class="collapse-toggle" id="toggle3">collapse â–²</span>
    </div>
    <div class="collapsible-body" id="body3">
      <div class="table-wrap" style="border-top:1px solid var(--top30-border)"><table id="top30Table"></table></div>
    </div>
  </div>

  <details class="debug">
    <summary>ğŸ” Debug â€” raw extracted text</summary>
    <pre id="rawText"></pre>
  </details>
</div>

<footer>RankForge &mdash; Client-side only &mdash; PDF.js &mdash; No data transmitted</footer>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let parsedData = null;
let subjectWeights = {};
let penaltyMode = 'category';
let mathsGroups = [];        // [{id, name, codes:[]}]  codes = raw class codes e.g. "10MMA1"
let mathsUnassigned = [];    // raw codes not yet in any group
let dragChip = null;         // {code, fromGroupId} or {code, fromUnassigned:true}
const subjectsVisible = {1:false, 2:false};
const CAT = {easy:0.8, normal:1.0, hard:1.2};
let groupIdCounter = 0;

const isYr710 = () => parseInt(document.getElementById('yearSelect').value) <= 10;

// â”€â”€ Panel toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePanel(h){ const b=h.nextElementSibling; b.classList.toggle('open'); h.classList.toggle('open'); }

// â”€â”€ Year / score mode change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onYearChange(){ /* just cosmetic for now; re-parse on upload */ }
function onScoreModeChange(){
  const p = document.getElementById('scoreMode').value==='percent';
  document.getElementById('rankKeyLabel').textContent = p?'Mark search key':'Rank search key';
  const inp = document.getElementById('rankKey');
  inp.placeholder = p?'e.g. Assessment Mark':'e.g. Overall Assessment Rank';
  if(p && inp.value==='Overall Assessment Rank') inp.value='Assessment Mark';
  if(!p && inp.value==='Assessment Mark') inp.value='Overall Assessment Rank';
}

// â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const zone=document.getElementById('uploadZone'), fileInput=document.getElementById('fileInput');
zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('drag-over')});
zone.addEventListener('dragleave',()=>zone.classList.remove('drag-over'));
zone.addEventListener('drop',e=>{e.preventDefault();zone.classList.remove('drag-over');const f=e.dataTransfer.files[0];if(f&&f.type==='application/pdf')handleFile(f);else setStatus('Please drop a PDF file.','error')});
fileInput.addEventListener('change',e=>{if(e.target.files[0])handleFile(e.target.files[0])});

function setStatus(m,t=''){const e=document.getElementById('status');e.textContent=m;e.className=t}
function setProgress(p){const b=document.getElementById('progressBar'),f=document.getElementById('progressFill');if(p===null){b.classList.remove('visible');return}b.classList.add('visible');f.style.width=p+'%'}

// â”€â”€ Section toggles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSection(bodyId,headerId,toggleId){
  const b=document.getElementById(bodyId),h=document.getElementById(headerId),t=document.getElementById(toggleId);
  const c=b.classList.contains('hidden');
  b.classList.toggle('hidden');h.classList.toggle('collapsed',!c);t.textContent=c?'collapse â–²':'expand â–¼';
}
function toggleSubjectsList(n){
  subjectsVisible[n]=!subjectsVisible[n];const v=subjectsVisible[n];
  const btn=document.getElementById('subjectsToggle'+n);
  btn.textContent=v?'â˜° Hide subject list column':'â˜° Show subject list column';
  btn.classList.toggle('active',v);
  const tbl=document.getElementById(n===1?'rankTable':'leaderTable');
  tbl.querySelectorAll('.col-subjects-list').forEach(el=>el.classList.toggle('hide',!v));
}

// â”€â”€ PDF extraction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleFile(file){
  setStatus('Loading PDFâ€¦');setProgress(5);
  const buf=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:buf}).promise;
  const n=pdf.numPages; let full='';
  for(let i=1;i<=n;i++){
    const pg=await pdf.getPage(i);const ct=await pg.getTextContent();
    const items=ct.items.slice().sort((a,b)=>{const dy=b.transform[5]-a.transform[5];return Math.abs(dy)>3?dy:a.transform[4]-b.transform[4]});
    const lines=[];let lastY=null,line=[];
    for(const it of items){const y=Math.round(it.transform[5]);if(lastY!==null&&Math.abs(y-lastY)>3){if(line.length)lines.push(line.join(' '));line=[]}if(it.str.trim())line.push(it.str.trim());lastY=y}
    if(line.length)lines.push(line.join(' '));
    full+=lines.join('\n')+'\n--- PAGE BREAK ---\n';
    setProgress(5+Math.round(i/n*60));
  }
  document.getElementById('rawText').textContent=full;
  setProgress(70);setStatus('Parsing student dataâ€¦');
  const year=document.getElementById('yearSelect').value;
  const key=document.getElementById('rankKey').value.trim()||'Overall Assessment Rank';
  const mode=document.getElementById('scoreMode').value;
  parsedData=parseText(full,year,key,mode);
  setProgress(90);
  if(!parsedData.students.length){setStatus('No student data found. Check the debug panel below.','error');document.getElementById('results').classList.add('visible');setProgress(null);return}

  // Init weights
  subjectWeights={};
  parsedData.allSubjects.forEach(s=>{subjectWeights[s]=1.0});

  // Init maths groups for Yr 7-10
  mathsGroups=[];mathsUnassigned=[];
  if(isYr710()&&parsedData.mathsCodes.length){
    mathsUnassigned=[...parsedData.mathsCodes];
    mathsGroups=[{id:++groupIdCounter,name:'Group 1',codes:[]},{id:++groupIdCounter,name:'Group 2',codes:[]},{id:++groupIdCounter,name:'Group 3',codes:[]}];
  }

  // Reset toggles
  subjectsVisible[1]=false;subjectsVisible[2]=false;
  ['subjectsToggle1','subjectsToggle2'].forEach(id=>{const b=document.getElementById(id);b.classList.remove('active');b.textContent='â˜° Show subject list column'});

  buildPenaltyPanel();
  renderTables();
  setProgress(null);
  setStatus(`âœ“ Found ${parsedData.students.length} students across ${parsedData.allSubjects.length} subjects.`,'success');
  document.getElementById('results').classList.add('visible');
  document.getElementById('uploadZone').style.display='none';
  // Show top30 section for Yr 7-10
  document.getElementById('top30Section').style.display=isYr710()?'':'none';
}

// â”€â”€ Parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseText(text,year,rankKey,scoreMode){
  const lines=text.split('\n').map(l=>l.trim()).filter(Boolean);
  const studentRe=/^([A-Z][A-Z'\-]+(?:\s+[A-Z][A-Z'\-]+)*,\s+[A-Z][a-zA-Z'\-]+(?:\s+[A-Z][a-zA-Z'\-]*)*)\s+Semester\b/;
  const ey=year.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  const subjectRe=new RegExp(`^(.+?)(?:\\s+-\\s+(?:HSC|Preliminary)?)?\\s+${ey}[A-Z]{2,}[\\dA-Z]*`);
  // Also capture the raw class code
  const subjectCodeRe=new RegExp(`^(.+?)(?:\\s+-\\s+(?:HSC|Preliminary)?)?\\s+(${ey}[A-Z]{2,}[\\dA-Z]*)`);
  const ek=rankKey.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  const rankRe=new RegExp(`${ek}[:\\s]+(\\d+)\\s*\\/\\s*(\\d+)`,'i');
  const pctRe=new RegExp(`${ek}[:\\s]+(\\d+(?:\\.\\d+)?)\\s*%`,'i');
  // G&T suffix detection: ends with T, X, TR or TG (before any trailing digits)
  const gtRe=new RegExp(`${ey}[A-Z]+(T|X|TR|TG)\\d*$`,'i');
  // Maths code: contains MMA
  const mathsCodeRe=new RegExp(`^${ey}MMA`,'i');

  const students=[];let cur=null,pend=null,pendCode=null;
  const mathsCodesSet=new Set();

  for(const line of lines){
    if(line.includes('--- PAGE BREAK ---'))continue;
    const sm=line.match(studentRe);
    if(sm){cur={name:sm[1].trim(),subjects:[],mathsCode:null};students.push(cur);pend=null;pendCode=null;continue}
    if(!cur)continue;
    if(scoreMode==='percent'){
      const pm=line.match(pctRe);
      if(pm&&pend){cur.subjects.push({name:pend,code:pendCode,score:parseFloat(pm[1]),isGT:pendCode?gtRe.test(pendCode):false});pend=null;pendCode=null;continue}
    } else {
      const rm=line.match(rankRe);
      if(rm&&pend){cur.subjects.push({name:pend,code:pendCode,rank:parseInt(rm[1]),total:parseInt(rm[2]),isGT:pendCode?gtRe.test(pendCode):false});pend=null;pendCode=null;continue}
    }
    const scm=line.match(subjectCodeRe);
    if(scm){
      pend=scm[1].replace(/\s+-\s*(?:HSC|Preliminary)?\s*$/,'').trim();
      pendCode=scm[2]||null;
      if(pendCode&&mathsCodeRe.test(pendCode)){mathsCodesSet.add(pendCode);cur.mathsCode=pendCode}
    }
  }

  const subjectSet=new Set();
  students.forEach(s=>s.subjects.forEach(sub=>subjectSet.add(sub.name)));
  const allSubjects=[...subjectSet].sort();
  const mathsCodes=[...mathsCodesSet].sort();
  return {students,allSubjects,mathsCodes,scoreMode};
}

// â”€â”€ G&T detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isGTSubject(subjectName){
  // Look up in parsed data â€” check if any subject entry for this name has isGT
  if(!parsedData)return false;
  for(const st of parsedData.students){
    const s=st.subjects.find(x=>x.name===subjectName);
    if(s&&s.isGT)return true;
  }
  return false;
}

// â”€â”€ Z-scores â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computeZScores(students,allSubjects){
  const stats={};
  allSubjects.forEach(subj=>{
    const scores=students.map(st=>{const s=st.subjects.find(x=>x.name===subj);return s?s.score:null}).filter(v=>v!==null);
    if(!scores.length){stats[subj]={mean:0,sd:1};return}
    const mean=scores.reduce((a,b)=>a+b,0)/scores.length;
    const sd=Math.sqrt(scores.reduce((a,b)=>a+(b-mean)**2,0)/scores.length)||1;
    stats[subj]={mean,sd};
  });
  return students.map(st=>({...st,subjects:st.subjects.map(s=>({...s,z:(s.score-stats[s.name].mean)/stats[s.name].sd}))}));
}

// â”€â”€ Get resolved subject name (handles maths grouping) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resolvedSubjectName(subjectName, studentMathsCode){
  // If this is a maths subject and we have grouping active, return the group name
  if(!isYr710()||!parsedData||!parsedData.mathsCodes.length)return subjectName;
  if(!subjectName.toLowerCase().includes('math')&&!/mma/i.test(subjectName))return subjectName;
  // Find which group this student's maths code belongs to
  if(!studentMathsCode)return subjectName;
  const grp=mathsGroups.find(g=>g.codes.includes(studentMathsCode));
  if(grp)return 'Maths: '+grp.name;
  return 'Maths: Unassigned ('+studentMathsCode+')';
}

// â”€â”€ Effective subjects list (with maths groups collapsed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getEffectiveSubjects(workingStudents){
  if(!isYr710()||!parsedData||!parsedData.mathsCodes.length)return parsedData.allSubjects;
  const set=new Set();
  workingStudents.forEach(st=>{
    st.subjects.forEach(s=>{
      set.add(resolvedSubjectName(s.name,st.mathsCode));
    });
  });
  return [...set].sort();
}

// â”€â”€ Compute avg â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computeAvg(student,isPercent){
  const subs=student.subjects;if(!subs.length)return null;
  if(isPercent){let ws=0,wt=0;subs.forEach(s=>{const rn=resolvedSubjectName(s.name,student.mathsCode);const w=subjectWeights[rn]??subjectWeights[s.name]??1.0;ws+=s.z*w;wt+=w});return wt>0?ws/wt:null}
  return subs.reduce((a,s)=>a+s.rank,0)/subs.length;
}

// â”€â”€ Build penalty panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPenaltyPanel(){
  const isPercent=parsedData.scoreMode==='percent';
  const panel=document.getElementById('penaltyPanel');
  const show=isPercent||isYr710();
  panel.style.display=show?'':'none';
  if(!show)return;

  const body=document.getElementById('penaltyBody');

  // Determine effective subjects for weighting
  let workingStudents=parsedData.students;
  if(isPercent)workingStudents=computeZScores(parsedData.students,parsedData.allSubjects);
  const effSubjects=getEffectiveSubjects(workingStudents);

  let html='';

  // â”€â”€ Weighting (percent mode only) â”€â”€
  if(isPercent){
    html+=`<div class="penalty-controls">
      <span class="penalty-mode-label">Difficulty mode:</span>
      <div class="seg-control">
        <button id="modeBtnCategory" class="${penaltyMode==='category'?'active':''}" onclick="setPenaltyMode('category')">Easy / Normal / Hard</button>
        <button id="modeBtnMultiplier" class="${penaltyMode==='multiplier'?'active':''}" onclick="setPenaltyMode('multiplier')">Custom multiplier</button>
      </div>
      <div class="category-legend" id="categoryLegend" style="${penaltyMode==='multiplier'?'display:none':''}">
        <span class="cat-badge easy">Easy Ã—0.8</span>
        <span class="cat-badge normal">Normal Ã—1.0</span>
        <span class="cat-badge hard">Hard Ã—1.2</span>
      </div>
    </div>`;

    // Separate GT from regular
    const gtSubjects=effSubjects.filter(s=>isGTSubject(s));
    const regSubjects=effSubjects.filter(s=>!isGTSubject(s));

    if(regSubjects.length){
      html+='<div class="penalty-section-label">Regular subjects</div><div class="penalty-grid" id="penaltyGridReg">';
      regSubjects.forEach(subj=>{html+=penaltyRowHTML(subj,false)});
      html+='</div>';
    }
    if(gtSubjects.length){
      html+='<div class="penalty-section-label">Gifted &amp; Talented classes</div><div class="penalty-grid" id="penaltyGridGT">';
      gtSubjects.forEach(subj=>{html+=penaltyRowHTML(subj,true)});
      html+='</div>';
    }
    html+=`<button class="penalty-apply-btn" onclick="applyWeights()">Apply weights &amp; re-rank</button>`;
  }

  // â”€â”€ Maths grouping (Yr 7-10) â”€â”€
  if(isYr710()&&parsedData.mathsCodes.length){
    html+=`<div class="penalty-section-label" style="margin-top:${isPercent?'1.5rem':'0'}">Maths class grouping</div>
    <p style="font-size:.72rem;color:var(--muted);margin-bottom:.75rem;line-height:1.6;">Drag maths class codes into groups. Each group will appear as a separate course column and can be weighted independently. Students not in any group will show their raw class code.</p>
    <div class="maths-group-controls">
      <button class="add-group-btn" onclick="addMathsGroup()">+ Add group</button>
    </div>
    <div class="maths-groups-container" id="mathsGroupsContainer"></div>`;
  }

  body.innerHTML=html;

  if(isYr710()&&parsedData.mathsCodes.length)renderMathsGroups();
}

function penaltyRowHTML(subj,isGT){
  const w=subjectWeights[subj]??1.0;
  const cat=catFromWeight(w);
  const rowStyle=weightStyle(w);
  const gtTag=isGT?'<span class="gt-badge">G&T</span>':'';
  if(penaltyMode==='category'){
    return `<div class="penalty-row" id="pr_${CSS.escape(subj)}" style="${rowStyle}" data-subject="${escAttr(subj)}">
      <span class="penalty-subject-name">${escHTML(subj)}</span>${gtTag}
      <select class="cat-select" onchange="onCatChange(this,'${escAttr(subj)}')">
        <option value="easy"${cat==='easy'?' selected':''}>Easy</option>
        <option value="normal"${cat==='normal'?' selected':''}>Normal</option>
        <option value="hard"${cat==='hard'?' selected':''}>Hard</option>
      </select></div>`;
  } else {
    return `<div class="penalty-row" id="pr_${CSS.escape(subj)}" data-subject="${escAttr(subj)}">
      <span class="penalty-subject-name">${escHTML(subj)}</span>${gtTag}
      <input type="number" min="0" max="5" step="0.05" value="${w.toFixed(2)}" onchange="onMultChange(this,'${escAttr(subj)}')"/></div>`;
  }
}

function catFromWeight(w){return w<=0.85?'easy':w>=1.15?'hard':'normal'}
function weightStyle(w){
  if(w<1)return'border-color:#a8d0a8;background:#e8f4e8';
  if(w>1)return'border-color:#a8b8d8;background:#e8eef8';
  return'';
}
function onCatChange(sel,subj){subjectWeights[subj]=CAT[sel.value];const row=sel.closest('.penalty-row');row.style.cssText=weightStyle(CAT[sel.value])}
function onMultChange(inp,subj){subjectWeights[subj]=parseFloat(inp.value)||1.0}
function setPenaltyMode(m){
  penaltyMode=m;
  document.getElementById('modeBtnCategory').classList.toggle('active',m==='category');
  document.getElementById('modeBtnMultiplier').classList.toggle('active',m==='multiplier');
  document.getElementById('categoryLegend').style.display=m==='multiplier'?'none':'flex';
  if(parsedData)buildPenaltyPanel();
}
function applyWeights(){if(parsedData)renderTables()}

// â”€â”€ Maths groups drag UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMathsGroups(){
  const container=document.getElementById('mathsGroupsContainer');
  if(!container)return;
  let html='';

  // Unassigned pool
  html+=`<div class="maths-unassigned" id="dropUnassigned">
    <div class="maths-unassigned-header">Unassigned</div>
    <div class="maths-drop-zone" id="dz_unassigned" ondragover="dzOver(event)" ondragleave="dzLeave(event)" ondrop="dzDrop(event,'unassigned')">`;
  mathsUnassigned.forEach(code=>{html+=chipHTML(code,'unassigned')});
  html+='</div></div>';

  // Groups
  mathsGroups.forEach(g=>{
    html+=`<div class="maths-group-col" id="grp_${g.id}">
      <div class="maths-group-header">
        <input class="maths-group-name-input" value="${escAttr(g.name)}" placeholder="Group name" onchange="renameGroup(${g.id},this.value)" title="Click to rename"/>
        <button class="remove-group-btn" onclick="removeGroup(${g.id})" title="Remove group">âœ•</button>
      </div>
      <div class="maths-drop-zone" id="dz_${g.id}" ondragover="dzOver(event)" ondragleave="dzLeave(event)" ondrop="dzDrop(event,${g.id})">`;
    g.codes.forEach(code=>{html+=chipHTML(code,g.id)});
    html+='</div></div>';
  });

  container.innerHTML=html;
}

function chipHTML(code,groupId){
  return `<div class="maths-class-chip" draggable="true" id="chip_${code}" ondragstart="chipDragStart(event,'${code}',${JSON.stringify(groupId)})">
    ${escHTML(code)}
    <button class="chip-remove" onclick="moveChipTo('${code}','unassigned')" title="Move to unassigned">âœ•</button>
  </div>`;
}

function chipDragStart(e,code,fromGroupId){
  dragChip={code,fromGroupId};
  e.dataTransfer.effectAllowed='move';
  e.dataTransfer.setData('text/plain',code);
}
function dzOver(e){e.preventDefault();e.currentTarget.classList.add('drag-over')}
function dzLeave(e){e.currentTarget.classList.remove('drag-over')}
function dzDrop(e,targetGroupId){
  e.preventDefault();e.currentTarget.classList.remove('drag-over');
  if(!dragChip)return;
  moveChipTo(dragChip.code,targetGroupId);
  dragChip=null;
}

function moveChipTo(code,targetGroupId){
  // Remove from current location
  mathsUnassigned=mathsUnassigned.filter(c=>c!==code);
  mathsGroups.forEach(g=>{g.codes=g.codes.filter(c=>c!==code)});
  // Add to target
  if(targetGroupId==='unassigned'){
    mathsUnassigned.push(code);
  } else {
    const g=mathsGroups.find(x=>x.id===targetGroupId||x.id===parseInt(targetGroupId));
    if(g)g.codes.push(code);
  }
  renderMathsGroups();
  // Re-init weights for new group names
  const effNames=[];
  mathsGroups.forEach(g=>{if(g.codes.length)effNames.push('Maths: '+g.name)});
  effNames.forEach(n=>{if(!(n in subjectWeights))subjectWeights[n]=1.0});
}

function addMathsGroup(){
  mathsGroups.push({id:++groupIdCounter,name:'Group '+(mathsGroups.length+1),codes:[]});
  renderMathsGroups();
}
function removeGroup(id){
  const g=mathsGroups.find(x=>x.id===id);
  if(g){g.codes.forEach(c=>mathsUnassigned.push(c));mathsGroups=mathsGroups.filter(x=>x.id!==id)}
  renderMathsGroups();
}
function renameGroup(id,name){
  const g=mathsGroups.find(x=>x.id===id);if(g){const old='Maths: '+g.name;g.name=name;const nw='Maths: '+name;if(old in subjectWeights){subjectWeights[nw]=subjectWeights[old];delete subjectWeights[old]}}
}

// â”€â”€ Render tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTables(){
  if(!parsedData)return;
  const {students,allSubjects,scoreMode}=parsedData;
  const isPercent=scoreMode==='percent';
  let ws=isPercent?computeZScores(students,allSubjects):students;
  const effSubjects=getEffectiveSubjects(ws);

  // pill helper
  function pillFor(s,subjectName,studentMathsCode){
    if(!s)return'<span class="pill missing">â€”</span>';
    const rn=resolvedSubjectName(subjectName,studentMathsCode);
    const gt=isGTSubject(rn)||isGTSubject(subjectName);
    if(isPercent){
      const cls=s.score>=80?'top':s.score<50?'bottom':'';
      return`<span class="pill ${cls}${gt?' gt':''}">${s.score.toFixed(1)}%</span>`;
    } else {
      const ratio=s.rank/s.total;const cls=ratio<=0.25?'top':ratio>=0.75?'bottom':'';
      return`<span class="pill ${cls}${gt?' gt':''}">${s.rank}/${s.total}</span>`;
    }
  }

  // Build per-student effective subject map (maths resolved)
  function buildSubMap(student){
    const m={};
    student.subjects.forEach(s=>{
      const rn=resolvedSubjectName(s.name,student.mathsCode);
      m[rn]=s;
    });
    return m;
  }

  // â”€â”€ Table 1 â”€â”€
  document.getElementById('rankCount').textContent=`${students.length} students Â· ${effSubjects.length} subjects`;
  let h=`<thead><tr><th>Student</th><th class="center col-subjects-list hide">Subjects</th><th class="center">Subjects Found</th>`;
  effSubjects.forEach(s=>{
    const gt=isGTSubject(s);
    h+=`<th class="center"${gt?' style="border-bottom:2px solid var(--gt-border)"':''}>${escHTML(s)}${gt?' <span style="font-size:.55rem;color:var(--gt-border)">G&T</span>':''}</th>`;
  });
  h+='</tr></thead><tbody>';
  ws.forEach(st=>{
    const sm=buildSubMap(st);
    const subList=effSubjects.filter(subj=>sm[subj]).join(', ');
    h+=`<tr><td class="name">${escHTML(st.name)}</td><td class="subjects-list-cell col-subjects-list hide">${escHTML(subList)||'â€”'}</td><td class="center">${st.subjects.length}</td>`;
    effSubjects.forEach(subj=>{
      const s=sm[subj];
      h+=`<td class="center">${s?pillFor(s,subj,st.mathsCode):'<span class="pill missing">â€”</span>'}</td>`;
    });
    h+='</tr>';
  });
  h+='</tbody>';
  document.getElementById('rankTable').innerHTML=h;
  if(!subjectsVisible[1])document.getElementById('rankTable').querySelectorAll('.col-subjects-list').forEach(el=>el.classList.add('hide'));

  // â”€â”€ Leaderboard â”€â”€
  const withAvg=ws.map(st=>({...st,avg:computeAvg(st,isPercent),rawZ:isPercent?st.subjects.reduce((a,s)=>a+s.z,0)/Math.max(st.subjects.length,1):null}))
    .sort((a,b)=>{if(a.avg===null)return 1;if(b.avg===null)return -1;return isPercent?b.avg-a.avg:a.avg-b.avg});

  const anyW=isPercent&&effSubjects.some(s=>(subjectWeights[s]??1.0)!==1.0);
  document.getElementById('boardCount').textContent=isPercent?(anyW?'Weighted avg z-score':'Avg z-score'):'Lowest average rank';
  const scoreLabel=isPercent?(anyW?'Wtd. Avg Z':'Avg Z-Score'):'Avg Rank';

  let h2=`<thead><tr><th class="center">Position</th><th>Student</th><th class="center col-subjects-list hide">Subjects</th><th class="center">Subjects Found</th><th class="center">${scoreLabel}</th>`;
  effSubjects.forEach(s=>{
    const gt=isGTSubject(s);
    h2+=`<th class="center"${gt?' style="border-bottom:2px solid var(--gt-border)"':''}>${escHTML(s)}${gt?' <span style="font-size:.55rem;color:var(--gt-border)">G&T</span>':''}</th>`;
  });
  h2+='</tr></thead><tbody>';

  withAvg.forEach((st,idx)=>{
    const pos=idx+1;
    const isTop30=isYr710()&&pos<=30;
    const medal=pos===1?'ğŸ¥‡':pos===2?'ğŸ¥ˆ':pos===3?'ğŸ¥‰':'';
    const pCls=pos===1?'p1':pos===2?'p2':pos===3?'p3':isTop30?'top30':'';
    const rowCls=pos===1?'gold':isTop30?'top30':'';
    const sm=buildSubMap(st);
    const subList=effSubjects.filter(subj=>sm[subj]).join(', ');
    let avgCell;
    if(st.avg===null){avgCell='â€”'}
    else if(isPercent){
      const disp=st.avg.toFixed(3);
      avgCell=anyW&&st.rawZ!==null?`<span class="has-tip" data-tip="Unweighted avg z: ${st.rawZ.toFixed(3)}">${disp}</span>`:disp;
    } else {avgCell=st.avg.toFixed(2)}

    h2+=`<tr class="${rowCls}">
      <td class="center"><span class="position-badge ${pCls}">${medal||pos}</span></td>
      <td class="name">${escHTML(st.name)}</td>
      <td class="subjects-list-cell col-subjects-list hide">${escHTML(subList)||'â€”'}</td>
      <td class="center">${st.subjects.length}</td>
      <td class="center" style="font-weight:500">${avgCell}</td>`;
    effSubjects.forEach(subj=>{const s=sm[subj];h2+=`<td class="center">${s?pillFor(s,subj,st.mathsCode):'<span class="pill missing">â€”</span>'}</td>`});
    h2+='</tr>';
  });
  h2+='</tbody>';
  document.getElementById('leaderTable').innerHTML=h2;
  if(!subjectsVisible[2])document.getElementById('leaderTable').querySelectorAll('.col-subjects-list').forEach(el=>el.classList.add('hide'));

  // â”€â”€ Top 30 â”€â”€
  if(isYr710()){
    const top30=withAvg.slice(0,30);
    document.getElementById('top30Count').textContent=`${top30.length} students`;
    let h3=`<thead><tr><th class="center">Position</th><th>Student</th><th class="center">Subjects Found</th><th class="center">${scoreLabel}</th>`;
    effSubjects.forEach(s=>{const gt=isGTSubject(s);h3+=`<th class="center"${gt?' style="border-bottom:2px solid var(--gt-border)"':''}>${escHTML(s)}</th>`});
    h3+='</tr></thead><tbody>';
    top30.forEach((st,idx)=>{
      const pos=idx+1;
      const medal=pos===1?'ğŸ¥‡':pos===2?'ğŸ¥ˆ':pos===3?'ğŸ¥‰':'';
      const pCls=pos===1?'p1':pos===2?'p2':pos===3?'p3':'top30';
      const sm=buildSubMap(st);
      let avgCell=st.avg===null?'â€”':isPercent?(anyW&&st.rawZ!==null?`<span class="has-tip" data-tip="Unweighted: ${st.rawZ.toFixed(3)}">${st.avg.toFixed(3)}</span>`:st.avg.toFixed(3)):st.avg.toFixed(2);
      h3+=`<tr class="top30">
        <td class="center"><span class="position-badge ${pCls}">${medal||pos}</span></td>
        <td class="name">${escHTML(st.name)}</td>
        <td class="center">${st.subjects.length}</td>
        <td class="center" style="font-weight:500">${avgCell}</td>`;
      effSubjects.forEach(subj=>{const s=sm[subj];h3+=`<td class="center">${s?pillFor(s,subj,st.mathsCode):'<span class="pill missing">â€”</span>'}</td>`});
      h3+='</tr>';
    });
    h3+='</tbody>';
    document.getElementById('top30Table').innerHTML=h3;
  }
}

// â”€â”€ CSV Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV(which){
  if(!parsedData)return;
  const {students,allSubjects,scoreMode}=parsedData;
  const isPercent=scoreMode==='percent';
  const year=document.getElementById('yearSelect').value;
  let ws=isPercent?computeZScores(students,allSubjects):students;
  const effSubjects=getEffectiveSubjects(ws);
  function buildSubMap(st){const m={};st.subjects.forEach(s=>{const rn=resolvedSubjectName(s.name,st.mathsCode);m[rn]=s});return m}
  function scoreStr(s){if(!s)return'';return isPercent?s.score.toFixed(1)+'%':`${s.rank}/${s.total}`}
  const sl=isPercent?'Avg Z-Score':'Avg Rank';
  let rows=[];
  if(which==='ranks'){
    rows.push(['Student','Subjects','Subjects Found',...effSubjects]);
    ws.forEach(st=>{const sm=buildSubMap(st);rows.push([st.name,effSubjects.filter(s=>sm[s]).join('; '),st.subjects.length,...effSubjects.map(s=>scoreStr(sm[s]))])});
  } else {
    const wa=ws.map(st=>({...st,avg:computeAvg(st,isPercent)})).sort((a,b)=>{if(a.avg===null)return 1;if(b.avg===null)return -1;return isPercent?b.avg-a.avg:a.avg-b.avg});
    rows.push(['Position','Student','Subjects','Subjects Found',sl,...effSubjects]);
    wa.forEach((st,i)=>{const sm=buildSubMap(st);rows.push([i+1,st.name,effSubjects.filter(s=>sm[s]).join('; '),st.subjects.length,st.avg!==null?st.avg.toFixed(3):'',...effSubjects.map(s=>scoreStr(sm[s]))])});
  }
  const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`rankforge-year${year}-${which}.csv`;a.click();URL.revokeObjectURL(url);
}

// â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetTool(){
  parsedData=null;subjectWeights={};mathsGroups=[];mathsUnassigned=[];
  document.getElementById('results').classList.remove('visible');
  document.getElementById('uploadZone').style.display='';
  document.getElementById('fileInput').value='';
  document.getElementById('penaltyPanel').style.display='none';
  document.getElementById('top30Section').style.display='none';
  setStatus('');setProgress(null);
  ['body1','body2','body3'].forEach(id=>document.getElementById(id).classList.remove('hidden'));
  ['header1','header2','header3'].forEach(id=>document.getElementById(id).classList.remove('collapsed'));
  ['toggle1','toggle2','toggle3'].forEach(id=>{document.getElementById(id).textContent='collapse â–²'});
}

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHTML(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function escAttr(s){return String(s).replace(/"/g,'&quot;').replace(/'/g,'&#39;')}
</script>
</body>
</html>
